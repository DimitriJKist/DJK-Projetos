#include <stdint.h>
#include <stdlib.h>
#include "tm4c123gh6pm.h"

int PWMGERAL=0;
int delay=0;

int FREQ_AD=60000;
int FREQ_PWM=20000;

int DUTY=2000;
int trava = 0;
float velocidade=0;

float IFilt=0, Imedido_antigo=0, IFilt_antigo=0;
float AD0=0, AD1=0, Imedido=0, Vmedido=0, Err_RPM=0, EkI=0, Iref=0, Duty=2000;
float vet1[2500],vet2[2500];
float Err_RPM_antigo=0, Iref_antigo=0, EkIantigo=0, Duty_antigo=0, velocidade_antiga=0, VFilt=0;
int x=0, i=0, teste=0, tipo_teste=4;
float var1, var2, var3, var1soma=0, var2soma=0, var3soma=0;
int novas_constantes=0, dir = 0, filtrodir=0, direcaocorreta=0;

float a1=0, b1=0, a2=0, b2=0, Ta=1.666666666666667e-5;
uint8_t controleON=0;
int contador_vento=0, pos=1;
float vento[]={2.2309492,1.0228048,0.6621028,0.9069932,1.1930672,1.2721176,0.8196508,0.8776948,1.533592,1.0883116,1.2746052,1.287596,1.0440876,1.1087652,1.0476808,1.3094316,1.537738,1.5855552,3.6021696,3.3791148,3.935508,4.5234108,4.7354096,4.9214268,5.3211012,5.2638864,4.7818448,5.5494076,4.901526,4.8719512,5.596672,5.6292872,5.9501876,7.4521452,7.376688,6.3216692,5.6859492,6.1837456,6.412052,6.6713152,5.4150772,6.0991672,4.5217524,5.967048,6.4388628,7.604718,7.0745828,6.179876,7.7075388,5.5422212,6.9062552,5.9164668,6.2749576,7.957128,8.0707284,7.5690624,7.9560224,7.6619328,6.8014996,6.9076372,7.031188,8.067688,6.6605356,7.2594944,6.8056456,6.3932568,6.4734128,8.5052292,6.2616904,8.1351296,5.9548864,6.5005,6.9908336,6.6422932,6.7487072,5.6433836,5.6635608,5.7055736,5.0679188,5.9816972,4.6046724,4.907054,5.925588,4.0527016,4.1569044,3.974204,3.620412,3.5662376,3.730972,4.340434,3.3791148,3.9512628,4.0886336,3.636996,4.079236,3.848442,3.7856992,4.4283292,3.2729772,3.43246,3.1168112,3.9761388,4.0974784,4.6787476,3.83324,4.8244104,4.7575216,4.2141192,3.2660672,2.5938624,2.2044148,3.0059748,2.466442,2.469206,4.8755444,3.3655712,2.8075196,4.713574,4.0947144,3.6234524,6.0825832,3.8542464,4.8841128,5.2121996,4.0996896,3.4180872,5.8548296,3.5571164,4.5446936,4.3028436,4.305884,3.6903412,3.2820984,3.6195828,3.961766,4.4656432,4.0269964,3.0562796,5.1021924,4.1765288,5.0939004,4.424736,4.0770248,5.7370832,4.3324184,5.1325964,2.9026012,3.5007308,3.93689,5.3503996,5.3708532,4.3738784,3.4266556,3.3849192,4.4783576,3.4482148,4.326614,4.1339632,4.854538,2.4454356,3.2436788,3.9122904,4.4291584,5.2379048,4.7876492,5.7080612,3.730972,4.0726024,2.5330544,4.173212,3.5947068,4.815842,3.8514824,3.1856348,3.7505964,3.7177048,4.3398812,3.6939344,3.4059256,3.1582712,4.7293288,3.309462,3.1734732,2.8426224,4.1909016,3.7016736,3.4979668,4.0048844,2.7212828,2.5416228,4.8763736,5.2135816,3.7895688,3.0916588,5.017614,3.0148196,3.654962,3.742028,4.2887472,4.4404908,3.914778,4.3658628,4.908436,3.147768,4.2718868,5.2707964,4.0574004,3.6989096,4.9244672,4.4037296,4.8528796,5.6149144,4.2846012,3.2160388,5.5087768,5.0679188,5.5488548,5.582852,5.4007044,7.0696076,8.7150168,8.1553068,9.0154636,8.4322596,8.7553712,8.9806372,6.7332288,5.5706904,5.0919656,6.3379768,5.497168,5.4106548,5.8153044,6.0173528,4.446848,6.2788272,4.7967704,3.9634244,4.652766,6.8733636,7.8291548,7.071266,8.6174476,6.7965244,7.4256108,8.4916856,9.352948,6.9402524,6.8683884,8.1931736,5.7028096,5.6500172,8.357908,9.014358,7.8250088,7.784378,7.1563972,9.1547692,8.8515584,7.5240092,8.715846,8.4264552,7.559112,7.3507064,7.8526488,6.0676576,8.9076676,9.52708,6.6558368,8.3388364,7.4093032,6.0173528,9.4328276,7.957128,9.4015944,7.0790052,5.9872252,6.3432284,9.0104884,8.156136,8.1456328,9.8651172,9.7581504,11.0494912,8.595612,7.0596572,8.3349668,7.291004,10.3164784,9.9096176,7.1190832,9.8313964,12.3013068,9.1370796,9.5917576,7.5430808,8.4966608,8.0914584,7.957128,7.7730456,8.4582412,8.0154484,7.8711676,9.2716864,7.8017912,8.4292192,8.6486808,9.9599224,7.9629324,9.7755636,9.0768244,10.0630196,7.3941012,6.717474,5.0712356,5.8473668,6.3128244,9.7932532,8.3485104,7.766412,5.4620652,7.9485596,7.7147252,8.554152,7.4283748,6.6782252,9.3908148,7.093378,9.318398,9.2716864,9.0342588,8.2716712,7.4585024,8.9892056,11.1492716,11.4886908,9.5265272,9.7739052,9.4002124,10.77779,10.4408584,8.626016,8.7678092,7.955746,10.7949268,11.535126,10.0959112,8.596994,9.1182844,7.8075956,9.2169592,10.4325664,6.232392,6.1140928,5.488876,7.7741512,7.333846,7.3056532,7.0206848,7.5552424,4.547734,3.9750332,3.5090228,5.9388552,4.2613836,5.4457576,5.5941844,6.066552,8.1691268,8.49749,6.9457804,8.0898,5.3633904,5.6500172,7.0212376,5.9515696,4.3807884,5.4689752,6.2133204,5.2312712,6.0908752,3.844296,5.5154104,7.4488284,6.9977436,8.0035632,5.4919164,5.797062,6.4419032,7.9582336,7.2249444,6.3045324,5.92697,6.8905004,6.3559428,6.0455456,6.4048656,2.408398,5.0845028,4.9930144,3.4222332,2.8594828,5.231824,4.7962176,6.4167508,8.2116924,4.8796904,6.5234412,5.135084,2.8857408,2.337916,1.9188936,3.4667336,4.4650904,5.4725684,4.8058916,2.4307864,3.4363296,3.3816024,3.4581652,5.6356444,4.2873652,3.0875128,3.3318504,4.2127372,1.8066752,3.2934308,4.1314756,3.9062096,4.3716672,6.7542352,4.3324184,4.8700164,6.702272,7.7835488,7.271656,5.7517324,3.8600508,3.869172,5.0684716,3.2019424,4.8105904,3.9150544,5.0101512,2.0236492,2.9153156,2.4570444,5.10468,5.3407256,5.3570332,4.8086556,4.6118588,3.8390444,4.9136876,5.4966152,4.211908,6.0488624,5.0391732,3.3583848,3.9001288,5.071512,5.7757792,4.7365152,6.4764532,3.6599372,4.6535952,4.0435804,3.1071372,1.5172844,1.8088864,4.0900156,1.0446404,1.8456476,2.9125516,2.0468668,1.4208208,2.0244784,2.532778,1.909496,1.8898716,0.7049448,0.5750368,2.3412328,4.8921284,5.8573172,4.8147364,3.5833744,2.9189088,3.2049828,2.4048048,1.6919692,1.7068948,2.5067964,1.700814,1.945428,1.3929044,2.024202,1.8923592,4.1475068,4.837954,3.4860816,2.9764,3.628704,2.234266,1.8959524,2.763572,3.3594904,2.5333308,2.067044,0.5637044,1.0252924,3.870554,5.0529932,3.4316308,1.6499564,2.5720268,3.7464504,5.48473,2.7417364,2.6781644,1.6811896,1.1156752,0.621472,2.496846,0.8298776,1.00705,1.9310552,3.8020068,0.8735488,0.4617128,0.5877512,1.367752,1.2237476,0.8580704,0.915838,0.8475672,0.8312596,0.582776,1.858362,1.7552648,0.7469576,1.8710764,0.933804,0.6502176,1.8547688,0.6388852,0.6024004,1.855598,2.0756124,2.447094,2.8171936,1.3876528,1.1773124,1.146632,1.3238044,2.1944644,2.1132028,2.5966264,1.6886524,2.7143728,2.8260384,4.8998676,2.2212752,1.1999772,0.9163908,1.1773124,2.5526788,0.9871492,2.9020484,1.830722,4.9587408,3.1729204,3.9214116,2.6380864,3.027534,5.5637804,1.9106016,0.8320888,1.4307712,3.6237288,3.3990156,4.1226308,5.824702,4.50351,4.0941616,5.9125972,1.059566,2.9614744,4.3415396,5.1165652,3.095252,4.5444172,2.5803188,2.5427284,3.1801068,5.1135248,5.7868352,4.9642688,6.2210596,4.1499944,5.5726252,4.8788612,3.2674492,5.4241984,3.440752,4.6602288,1.855598,5.5098824,4.173212,4.9700732,2.6588164,4.1182084,6.1834692,5.4153536,4.1370036,4.2110788,3.9192004,2.148582,4.9626104,0.998758,0.584158,2.592204,3.887138,4.882178,4.5220288,6.4211732,1.7013668,1.4871568,1.2273408,1.6709628,2.539688,4.0444096,3.9902352,5.9816972,3.7928856,4.0399872,3.6021696,2.8835296,2.3777176,2.6051948,3.3473288,2.8401348,2.7751808,1.9382416,2.5164704,3.5272652,6.3534552,6.8921588,6.3835828,3.558222,3.809746,3.0021052,6.3172468,5.0828444,2.4341032,1.5941236,1.713252,4.796494,3.9114612,3.2754648,6.2017116,4.0891864,5.7547728,4.1444664,1.6463632,6.5049224,5.306452,5.841286,1.5935708,2.8434516,2.3757828,4.1099164,5.3545456,2.9924312,4.1516528,2.9412972,3.3874068,4.6345236,2.8246564,4.8479044,3.6486048,5.393518,5.3197192,5.7608536,5.0698536,4.281008,5.3960056,5.0178904,3.0347204,3.6334028,4.6441976,5.1859416,5.3846732,4.7365152,5.2224264,4.9297188,1.226788,1.7480784,3.0988452,4.3595056,2.1712468,2.8116656,2.8854644,3.1759608,2.6988944,4.5433116,4.159392,3.519526,3.0712052,4.5784144,4.3161108,5.2992656,3.882992,3.6364432,4.0164932,5.7835184,4.4996404,3.7138352,5.3614556,5.3937944,4.3882512,4.9117528,4.5690168,3.554076,3.4634168,4.3111356,5.0999812,4.044686,3.754466,2.9255424,5.3719588,3.0794972,3.8047708,3.7884632,2.4224944,3.8232896,3.6942108,2.5280792,3.3265988,4.2108024,2.6704252,2.9703192,3.6430768,2.9628564,3.262474,3.4993488,3.1922684,3.5258832,3.1397524,3.5974708,2.3984476,2.6836924,3.1170876,3.3780092,2.6118284,3.9943812,3.5203552,4.1875848,3.6919996,3.2304116,3.46701,2.7597024,2.8274204,2.8813184,2.1966756,2.957052,3.3741396,2.4537276,3.1613116,2.2818068,2.6021544,2.8116656,2.7516868,2.724876,1.917788,2.7306804,2.641956,3.1704328,2.5330544,2.687562,3.1204044,3.0761804,2.4703116,2.1353148,2.2663284,2.2624588,2.0653856,2.2005452,2.018674,2.4863428,1.8655484,2.3359812,2.054606,2.1062928,2.2110484,2.0054068,2.829908,2.144436,1.9180644,1.6173412,1.4841164,1.9871644,1.4772064,1.7480784,1.7972776,2.0510128,2.415308,2.6215024,2.051842,2.2961796,2.6549468,2.932176,2.6275832,2.9440612,2.9136572,2.557654,3.0023816,2.463678,3.5258832,3.1745788,2.67236,2.7699292,3.652198,3.450426,3.3885124,2.7671652,2.7610844,2.9979592,3.4316308,2.6914316,2.2113248,1.8412252,2.2862292,2.1687592,1.827958,2.2677104,2.5278028,2.7749044,2.366938,2.296456,2.4813676,2.5841884,2.1419484,1.9075612,1.993798,2.065662,2.0123168,2.0300064,1.5758812,1.87771,1.8202188,2.1491348,1.9973912,1.9788724,2.04355,2.0496308,2.401488,2.4495816,1.9976676,2.1317216,2.2160236,2.0081708,2.0125932,2.025584,1.8813032,2.5302904,2.6582636,3.1162584,2.9026012,2.4202832,3.1101776,3.0922116,3.5023892,3.666018,3.3735868,3.444898,3.9664648,3.762758,4.1209724,3.5750824,3.209958,2.8567188,3.7423044,3.75723,2.9067472,2.6914316,3.0236644,2.9830336,3.10078,2.9028776,2.850638,3.0877892,3.0148196,3.0518572,3.023388,2.6740184,3.0725872,2.5463216,2.4260876,2.867222,2.4531748,1.9042444,2.2237628,2.235648,2.2132596,1.9653288,2.7765628,1.924698,1.9393472,2.7544508,2.5181288,2.7046988,2.9752944,3.511234,3.4183636,3.2351104,3.5808868,3.0720344,3.4985196,3.388236,3.2226724,3.2682784,3.2262656,3.0222824,3.2400856,3.2392564,3.0294688,2.5891636,3.0383136,2.96949,3.2453372,2.4957404,2.7522396,2.752516,2.5385824,2.5076256,2.6231608,2.8089016,2.9371512,2.811942,2.7033168,3.12842,2.8039264,2.5076256,2.9775056,3.7400932,3.5173148,2.8954148,3.8520352,3.7978608,3.51538,4.38604,4.3716672,3.84706,4.8595132,4.2862596,4.4147856,3.2102344,3.9678468,4.343198,4.2016812,4.3865928,4.4601152,4.3426452,3.921688,4.2945516,3.298406,4.363928,2.7127144,3.6104616,3.461482,2.9186324,4.1958768,4.4822272,4.6723904,4.8221992,4.5645944,5.1486276,4.9985424,3.8495476,5.158578,4.6640984,5.1328728,5.1928516,5.0289464,4.7072168,4.0311424,3.6751392,2.6159744,2.9374276,3.6682292,4.8968272,3.917542,4.112404,4.3000796,3.8771876,4.76609,4.2696756,4.8625536,3.4155996,3.9692288,4.276862,4.1394912,4.6806824,4.370838,4.8202644,3.3365492,3.373034,3.2989588,4.7597328,5.0004772,3.1264852,4.3857636,2.9014956,4.6715612,5.186218,4.4181024,4.9404984,5.1649352,5.171016,4.1803984,4.6732196,4.7251828,4.9286132,4.9814056,4.7478476,5.8484724,5.0013064,5.0140208,5.6801448,4.5350196,5.5250844,6.4103936,5.5377988,6.0864528,6.2528456,6.1989476,6.9714856,6.8697704,6.391322,5.4880468,6.6757376,6.6655108,6.575128,6.6970204,7.4175952,7.194264,7.3316348,7.0439024,8.0643712,7.800962,7.09476,7.0278712,8.0019048,7.3858092,7.1425772,7.340756,6.125978,5.7871116,5.223532,6.441074,5.9015412,6.6447808,7.0441788,5.9955172,6.2984516,7.7340732,7.9366744,7.1895652,6.5029876,6.1856804,6.8578852,6.8924352,5.7274092,7.5892396,6.351244,5.9161904,6.559926,5.7605772,5.0054524,5.7511796,5.8028664,5.4684224,5.446034,3.4247208,5.1450344,3.5781228,3.74341,3.3257696,3.6082504,6.1469844,5.8194504,3.9153308,5.661626,3.4031616,4.0620992,4.0952672,3.3418008,5.0007536,3.0092916,5.2500664,6.076226,5.4767144,5.7135892,6.2970696,5.517898,4.305884,3.454572,4.0499376,6.3766728,5.0999812,4.8125252,5.786006,6.5651776,6.4499188,6.615206,5.4394004,5.815028,6.228246,6.5872896,6.1317824,5.2323768,4.8722276,4.8520504,5.2564236,5.3199956,5.4067852,5.4728448,6.2456592,4.286536,5.0118096,5.8545532,4.9825112,4.7188256,4.3208096,5.5748364,5.3915832,4.0275492,4.9020788,3.9139488,5.58147,5.3738936,6.3363184,4.9711788,5.4319376,6.3722504,6.425872,5.52619,6.034766,4.1292644,2.3506304,2.1013176,3.887138,5.1983796,4.721866,4.263042,4.0817236,3.9993564,4.6953316,4.8658704,3.6884064,4.0040552,4.0518724,4.181504,3.7445156,4.1187612,4.06818,3.7997956,3.8644732,3.9241756,3.4374352,3.299788,3.3252168,3.5242248,3.3749688,5.0773164,4.3061604,3.7431336,4.6627164,3.6994624,4.278244,4.1101928,4.3089244,3.6842604,3.1455568,3.006804,3.5681724,3.614884,4.7428724,3.945182,4.2555792,3.1640756,3.3277044,4.198088,4.146954,3.5676196,3.7445156,3.6129492,3.4415812,4.2373368,3.9468404,3.6215176,2.9241604,4.5082088,4.4087048,4.6685208,5.0118096,4.5397184,4.7326456,4.0222976,4.0593352,3.7743668,3.3420772,4.6068836,5.3255236,4.1265004,3.9918936,4.6165576,4.4802924,4.6267844,4.2793496,5.2044604,4.5493924,4.0137292,4.685934,3.8451252,3.5643028,3.5535232,3.8840976,3.789016,3.6325736,3.6013404,3.7248912,4.86283,3.7210216,4.449612,4.955424,3.0946992,4.1909016,3.5449548,3.098016,3.554076,3.5626444,3.6814964,4.222964,3.627322,3.4855288,3.8210784,3.5087464,4.2315324,3.9725456,4.1654728,4.4255652,3.6005112,3.714388,3.5466132,3.8412556,3.9443528,3.759994,2.916974,4.3188748,3.9952104,4.6077128,3.0756276,3.2823748,2.7679944,2.9471016,2.4020408,2.8337776,2.1781568,3.3064216,3.0880656,2.7762864,2.7936996,2.564564,2.8000568,2.6662792,3.0076332,2.514812,3.3202416,3.1856348,2.9448904,2.6997236,2.9780584,3.2989588,3.104926,2.5532316,2.8984552,2.98331,3.0576616,2.9039832,2.5792132,2.3373632,2.3370868,2.7348264,2.0551588,2.780156,2.5711976,2.7646776,2.331006,2.459532,2.4791564,2.4006588,2.5413464,2.8992844,2.8882284,2.6908788,2.4868956,2.3857332,2.5416228,2.7983984,2.9435084,2.3970656,2.8440044,2.615698,2.7035932,2.8882284,2.7102268,2.857548,2.459532,2.232884,2.2616296,2.9921548,2.9150392,2.9133808,3.0142668,2.6994472,2.7779448,2.6601984,2.509284,2.3246488,2.27849,2.9990648,2.6734656,2.7776684,2.9545644,2.5540608,2.7818144,2.4672712,2.9269244,2.9042596,2.867222,2.5319488,2.7691,2.9692136,2.8887812,3.120128,2.7351028,3.0239408,2.8379236,2.7486464,2.9412972,2.9686608,3.1112832,3.447662,3.1411344,2.825762,3.5855856,3.0349968,3.1544016,2.6438908,2.749752,2.7420128,2.8382,2.8760668,2.7403544,2.8274204,2.708292,2.212154,2.7588732,2.5875052,2.8083488,3.262474,3.3851956,2.3509068,2.9368748,2.6057476,3.0720344,2.71382,2.6430616,2.7436712,3.1801068,3.0430124,2.9189088,2.7035932,3.1925448,2.9222256,2.8600356,3.091106,2.987456,2.2737912,2.4542804,2.780156,2.7715876,3.1991784,3.3962516,2.9075764,2.7301276,3.0930408,2.6718072,2.7917648,3.5728712,2.0322176,2.1930824,2.4100564,2.6477604,2.7754572,2.2776608,2.7450532,2.9772292,3.0430124,2.0731248,2.9305176,3.2890084,2.9189088,2.7257052,3.2898376,3.161588,2.6121048,2.6278596,2.599114,2.9385332};
float RPM_ref=500; //REFERENCIA RPM
//RPM (MALHA EXTERNA)
float KpRPM=0.0009; // 0.05 originalmente
float KiRPM=0.004; // 2 originalmente

// CORRENTE (MALHA INTERNA)
float Kpcorrente=0.1; // 50 originalmente 10x mais rapida que a malha externa
float Kicorrente=800;// 800 originalmente

float A1=0.050023333333333, B1=-0.049976666666667, A2=90.011666666666670, B2=-89.988333333333330, C1=1, C2=1;

void Clock_Init(long SYSDIV_var);
void PortE_Init(void);
void PortF_Init(void);
void Timer0A_Init(uint32_t period);
void ADC_Init(void);
void StartCritical(void);
void EndCritical(void);
void PWM1_1_Init(uint16_t period, uint16_t duty);
void QEI_INIT(void);
void EnableInterrupts(void);

//PE2 AD0 corrente
//PE3 AD1 tensao
//PWM PE4 (PADRAO) E PE5 (COMPLEMENTAR)
//PC5 e PC6 encoder

void main(void){

    a1=(2*KpRPM+Ta*KiRPM)/2;
    b1=(Ta*KiRPM-2*KpRPM)/(2*KpRPM+Ta*KiRPM);
    a2=(2*Kpcorrente+Ta*Kicorrente)/2;
    b2=(Ta*Kicorrente-2*Kpcorrente)/(2*Kpcorrente+Ta*Kicorrente);
    A1=a1;
    A2=a2;
    B1=a1*b1;
    B2=a2*b2;

    StartCritical();

    Clock_Init(4); //80M
    QEI_INIT();
    PortE_Init();
    PortF_Init();
    PWM1_1_Init(80000000/FREQ_PWM,(800000/FREQ_PWM)*(DUTY)-1);
    Timer0A_Init(80000000/FREQ_AD);
    ADC_Init();


    EnableInterrupts();
    EndCritical();

    PWM1_1_CTL_R  |= 0x01;           //  start PWM1_GEN1
    PWM1_ENABLE_R |= 0xC;
    TIMER0_CTL_R   = 0x01;

    while(1){
        if(RPM_ref > 5000){RPM_ref=5000;}

        if((QEI1_STAT_R & 0x02) == 0x02){dir=-1;}
        else{dir=1;}
        if(dir==1){filtrodir++; if(filtrodir>500){filtrodir=500;}}
        if(dir==-1){filtrodir=filtrodir-1;; if(filtrodir<-500){filtrodir=-500;}}
        if(filtrodir>0){direcaocorreta=1;}
        else{direcaocorreta=-1;}
        velocidade = (QEI1_SPEED_R*(float)7.32*direcaocorreta);

  }

}

void Timer0A_Handler(void){
    ADC0_PSSI_R=0x8;
    ADC1_PSSI_R=0x8;

    while(ADC0_RIS_R==0 && ADC1_RIS_R==0){}

    Imedido=(ADC0_SSFIFO3_R*(float)0.0062908728)-(float)12.3435166538;
    Vmedido=(ADC1_SSFIFO3_R*(float)0.1007326)-(int)207;//207 ANTERIORMENTE


    switch(controleON){
    case 0:
        PWM1_1_CMPA_R = DUTY-1 ;//(DUTY*(int)40)-(int)1; // malha aberta
        break;

    case 1:

        Err_RPM=(RPM_ref-velocidade);
        Iref=Err_RPM*A1 + Err_RPM_antigo*B1 + Iref_antigo*C1;
        if(Iref>9){Iref=9;}   //para achar corrente de ref          anteriormente 8
        if(Iref<-9){Iref=-9;}   // protecao anteriormente -8

        IFilt=(float)0.03046*Imedido + (float)0.03046*Imedido_antigo + (float)0.9391*IFilt_antigo;    //filtro pra corrente 2khz
        IFilt_antigo=IFilt;
        Imedido_antigo=Imedido;

        EkI=(Iref-Imedido);
        Duty=EkI*A2 + EkIantigo*B2 + Duty_antigo*C2 ;//+ (float)2000;
        if(Duty>3900){Duty=3900;} // correto é 4k
        if(Duty<100){Duty=100;}   //saturacao
        // if(Duty<1){Duty=1;}   //saturacao

        Err_RPM_antigo=Err_RPM;
        EkIantigo=EkI;
        Iref_antigo=Iref;
        Duty_antigo=Duty;  //atualizacao de var

        PWM1_1_CMPA_R = Duty-1; // malha fechada

        break;
    case 2:
        contador_vento++;
        if(contador_vento == 30000){
        RPM_ref=vento[pos]*400;
        pos++;
        if(pos == 1423) pos=1;
        contador_vento=0;
        }
        Err_RPM=(RPM_ref-velocidade);
        Iref=Err_RPM*A1 + Err_RPM_antigo*B1 + Iref_antigo*C1;
        if(Iref>9){Iref=9;}   //para achar corrente de ref          anteriormente 8
        if(Iref<-9){Iref=-9;}   // protecao anteriormente -8

        IFilt=(float)0.03046*Imedido + (float)0.03046*Imedido_antigo + (float)0.9391*IFilt_antigo;    //filtro pra corrente 2khz
        IFilt_antigo=IFilt;
        Imedido_antigo=Imedido;

        EkI=(Iref-Imedido);
        Duty=EkI*A2 + EkIantigo*B2 + Duty_antigo*C2 ;//+ (float)2000;
        if(Duty>3900){Duty=3900;} // correto é 4k
        if(Duty<100){Duty=100;}   //saturacao
        // if(Duty<1){Duty=1;}   //saturacao

        Err_RPM_antigo=Err_RPM;
        EkIantigo=EkI;
        Iref_antigo=Iref;
        Duty_antigo=Duty;  //atualizacao de var

        PWM1_1_CMPA_R = Duty-1; // malha fechada

        break;

    }


    if(novas_constantes==1){
        a1=(2*KpRPM+Ta*KiRPM)/2;
        b1=(Ta*KiRPM-2*KpRPM)/(2*KpRPM+Ta*KiRPM);
        a2=(2*Kpcorrente+Ta*Kicorrente)/2;
        b2=(Ta*Kicorrente-2*Kpcorrente)/(2*Kpcorrente+Ta*Kicorrente);
        A1=a1;
        A2=a2;
        B1=a1*b1;
        B2=a2*b2;
        novas_constantes=0;
    }


    switch (teste){
    case 1:
        switch(tipo_teste){
        case 1:
            if(i==0){RPM_ref=3000;}
            //  if(i==2000){RPM_ref=1000;}
            var1=velocidade;
            var2=Imedido;
            var3=Duty;
            break;
        case 2:
            if(i==0){RPM_ref=3000;}
            //  if(i==2000){RPM_ref=1000;}
            var1=Iref;
            var2=velocidade;
            var3=Duty;
            break;
        case 3:
            if(i==0){RPM_ref=3000;}
            //  if(i==2000){RPM_ref=2000;}
            var1=Imedido;
            var2=IFilt;
            var3=Iref;
            break;
        case 4:
            if(i==0){RPM_ref=3000;}
            //    if(i==2000){RPM_ref=2000;}
            var1=IFilt;
            var2=Iref;
            var3=Duty;
            break;
        }

        x++;
        var1soma=var1soma+var1/240;//soma para realziar a média do intervalo
        var2soma=var2soma+var2/240;
        var3soma=var3soma+var3/240;
        if(x==240){// para 1k colocar 60 | para 500Hz colocar 120  | 250Hz --> 240 | controle e aquisição esta em 60k
            vet1[i]= var1soma;
            vet2[i]= var2soma;
          //  vet3[i]= var3soma;
            i++;
            x=0;
            var1soma=0;
            var2soma=0;
            var3soma=0;
        }
        if(i==2500){ //i=2500 = 10seg
            RPM_ref=500;
            teste=0;
            i=0;
        }
        break;

        case 2:
            switch(tipo_teste){
            case 1:
                var1=Iref;
                var2=velocidade;
                var3=Duty;
                break;
            case 2:
                var1=velocidade;
                var2=RPM_ref;
                var3=Duty;
                break;
            case 3:
                var1=Imedido;
                var2=IFilt;
                var3=Iref;
                break;
            case 4:
                var1=IFilt;
                var2=Iref;
                var3=Duty;
                break;
            }
            x++;
            var1soma=var1soma+var1/240;//soma para realziar a média do intervalo
            var2soma=var2soma+var2/240;
            var3soma=var3soma+var3/240;
            if(x==240){
                vet1[i]= var1soma;
                vet2[i]= var2soma;
              //  vet3[i]= var3soma;
                i++;
                x=0;
                var1soma=0;
                var2soma=0;
                var3soma=0;
            }
            if(i==2500){
                i=0;
            }
            break;

            case 3:
                if(i>0 && i<100) RPM_ref=1000;
                if(i>100 && i<200) RPM_ref=2000;
                if(i>200 && i<300) RPM_ref=3000;
                if(i>300 && i<400) RPM_ref=4000;
                if(i>400 && i<500) RPM_ref=5000;
                x++;
                if(x==240){
                    i++;
                    x=0;
                }
                if(i >= 3000){
                    RPM_ref=1000;
                    teste=0;
                    i=0;
                }
              break;

    }
    TIMER0_ICR_R = 0x01;    //Sair da interrupcao
}


void ADC_Init(void){
    volatile unsigned long delay;
    SYSCTL_RCGC2_R |= 0x00000010; //  activate PORTE

    delay = SYSCTL_RCGC2_R;
    delay = SYSCTL_RCGC2_R;
    delay = SYSCTL_RCGC2_R;

    SYSCTL_RCGC0_R |= 0x030000; //  activate ADC0

    delay = SYSCTL_RCGCADC_R;
    delay = SYSCTL_RCGCADC_R;
    delay = SYSCTL_RCGCADC_R;

    ADC0_PC_R = 0x07;         //  configure for 1M samples/sec
    ADC1_PC_R = 0x07;         //  configure for 1M samples/sec
    ADC0_SSPRI_R |= 0x3210;   //  sequencer 0 is highest, sequencer 3 is lowest
    ADC1_SSPRI_R |= 0x3210;   //  sequencer 0 is highest, sequencer 3 is lowest
    ADC0_ACTSS_R &= ~0x08;    //  disable sample sequencer 3
    ADC1_ACTSS_R &= ~0x08;    //  disable sample sequencer 3
    ADC0_SAC_R = 0x04;        //  hardware average
    ADC1_SAC_R = 0x04;        //  hardware average
    ADC0_EMUX_R = (ADC0_EMUX_R&0xFFFF0FFF)+0x0000; //  activate software trigger event
    ADC1_EMUX_R = (ADC0_EMUX_R&0xFFFF0FFF)+0x0000; //  activate software trigger event
    ADC0_SSMUX3_R = 1;        //  Sample Input Select PE2
    ADC1_SSMUX3_R = 0;        //  Sample Input Select PE3
    ADC0_ACTSS_R |= 0x08;     //  enable sample sequencer 3
    ADC1_ACTSS_R |= 0x08;     //  enable sample sequencer 3
    ADC0_SSCTL3_R = 0x06;     //  set flag and end
    ADC1_SSCTL3_R = 0x06;     //  set flag and end
}

void Timer0A_Init(uint32_t period){
    SYSCTL_RCGCTIMER_R |= 0x01;  //  activate TIMER0
    TIMER0_CTL_R = 0x00;         //  disable TIMER0A during setup
    TIMER0_CFG_R = 0x04;         //  configure for 16-bit mode
    TIMER0_TAMR_R = 0x02;        //  configure for, down-count settings
    TIMER0_TAILR_R = period-1;   //  reload value
    TIMER0_TAPR_R = 0;           //  bus clock resolution
    TIMER0_IMR_R = 0x01;         //  mask
    NVIC_PRI4_R = 0x60000000;    //  priority 4
    NVIC_EN0_R |= 1<<19;
}

void PWM1_1_Init(uint16_t period, uint16_t duty){ //PE4 PADRAO E PE5 INVERSO
    volatile unsigned long delay;
    SYSCTL_RCGCPWM_R |= 0x03;       //  activate PWM
    delay = SYSCTL_RCGC2_R;
    delay = SYSCTL_RCGC2_R;
    SYSCTL_RCC_R &= ~0x00100000 ;   //  NOT use PWM divider
 // (SYSCTL_RCC_R & (~0x000E0000)); //  configure for /2 divider
    PWM1_1_CTL_R = 0x00;            //  DOWN mode
    PWM1_1_LOAD_R = period - 1;     //  80M/PERIOD = FREQ PWM
    PWM1_1_GENA_R = 0xC8;           //  LOW LOAD | HIGTH COMP A DOWN PE4
    PWM1_1_GENB_R = 0x8C;           //  LOW LOAD | HIGTH COMP B DOWM PE5
    PWM1_1_CMPA_R = duty - 1;       //  COMP A
 // PWM1_ENABLE_R |= 0xC0;
}

void PortE_Init(void){
    volatile unsigned long delay;
    SYSCTL_RCGC2_R |= 0x00000010;      //  activate PORTE
    delay = SYSCTL_RCGC2_R;
    delay = SYSCTL_RCGC2_R;
    delay = SYSCTL_RCGC2_R;
    GPIO_PORTE_DIR_R = 0x0F3;          //  make PE2, PE3 input and PE4,PE5 output
    GPIO_PORTE_AFSEL_R = 0x3C;         //  enable alternate function on PE2, PE3, PE4, PE5
    GPIO_PORTE_DEN_R  = 0x0F3;         //  disable digital I/O on PE2 and PE3
    GPIO_PORTE_AMSEL_R |= 0x0C;        //  enable analog functionality on PE2 and PE3
    GPIO_PORTE_PCTL_R = 0x550000;      //  PWM function to PE4 and PE5
}

void Clock_Init(long SYSDIV_var){
    SYSCTL_RCC2_R |= 0x80000000;
    SYSCTL_RCC2_R |= 0x00000800;
    SYSCTL_RCC_R &= ~0x00400000;
    SYSCTL_RCC_R &= ~0x000007C0;
    SYSCTL_RCC_R += 0x00000540;
    SYSCTL_RCC2_R &= ~0x00000070;
    SYSCTL_RCC2_R += 0x00000000;
    SYSCTL_RCC2_R &= ~0x00002000;
    SYSCTL_RCC2_R |= 0x40000000;
    SYSCTL_RCC2_R  = (SYSCTL_RCC2_R&~0x1FC00000)+ (SYSDIV_var<<22);
    SYSCTL_RCC_R  |= 0x00400000;
    while((SYSCTL_RIS_R&0x00000040)==0){};
    SYSCTL_RCC2_R &= ~0x00000800;
}

void QEI_INIT(void){
    SYSCTL_RCGC2_R    |= 0x04;
    GPIO_PORTC_PCTL_R |= 0x6600000;   // GPIO clear bit PCTL Port Control
    GPIO_PORTC_DIR_R   = 0x00;        // ALLINPUT
    GPIO_PORTC_AFSEL_R = 0x60;        // A PIN 5 // B PIN 6  // habilitando pinos para perifericos conforme tabela do datasheet
    GPIO_PORTC_PUR_R   = 0x60;        // PULL-UP
    GPIO_PORTC_DEN_R   = 0x60;        // DIGITAL ENEABLE
    SYSCTL_RCGCQEI_R  |= 0x02;       // ativa o modulos QEI1
    SYSCTL_RCGCGPIO_R |= 0x08;       // clock para port  C
    QEI1_CTL_R         = 0x2028;
    QEI1_MAXPOS_R      = (4*1024)-1;        // 4*600
    QEI1_LOAD_R        = 160000-1;    // 500Hz
    QEI1_CTL_R        |= 0x01;
}

 void PortF_Init(void){ volatile unsigned long delay;
     SYSCTL_RCGC2_R |= 0x00000020;     // F clock
     delay = SYSCTL_RCGC2_R;           // delay
     GPIO_PORTF_LOCK_R = 0x4C4F434B;   // unlock PortF PF0
     GPIO_PORTF_CR_R = 0x01;           // allow changes to PF0
     GPIO_PORTF_AMSEL_R = 0x00;        // disable analog function
     GPIO_PORTF_PCTL_R = 0x00000000;   // GPIO clear bit PCTL Port Control
     GPIO_PORTF_DIR_R = 0x0E;          // PF4,PF0 input, PF3,PF2,PF1 output
     GPIO_PORTF_AFSEL_R = 0x00;        // no alternate function
     GPIO_PORTF_PUR_R = 0x11;          // enable pullup resistors on PF4,PF0
     GPIO_PORTF_DEN_R = 0x1F;          // enable digital pins PF4-PF0
  }

